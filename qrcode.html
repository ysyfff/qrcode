<!DOCTYPE html>
<html>
<meta charset="utf-8" />

<head>
    <style>
        li {
            cursor: pointer;
        }

        #app {
            font-size: 13px;
        }

        .tag-wrap {
            background: #ccc;
            padding: 1px 5px;
            font-size: 12px;
            border-radius: 3px;
            margin-right: 8px;
        }

        .close {
            color: blue;
            cursor: pointer;
            padding: 1px 2px 4px 5px;
        }

        .add {
            color: blue;
            cursor: pointer;
            padding: 2px;
        }

        .content {
            cursor: pointer;
        }

        .ubt {
            margin: 15px 0;
        }

        .mtb15 {
            margin: 15px 0;
        }

        .ml10 {
            margin-left: 10px;
        }

        .inline-block {
            display: inline-block;
        }

        .text {
            color: #aaa;
            font-size: 12px
        }

        .label-name {
            display: inline-block;
            width: 100px;
            text-align: right;
            margin-right: 10px;
            margin-bottom: 6px;
            font-size: 13px;
        }

        .tips {
            color: #f00000;
        }
    </style>
</head>

<body>
    <div id="app">
        <div>
            <div class="label-name">CRN/QRN:</div>
            <label><input v-model="qc" type="radio" value="c" />CRN</label>
            <label class="ml10"><input v-model="qc" type="radio" value="q" />QRN</label>
        </div>
        <div>
            <div class="label-name">本地/壳:</div>
            <label><input v-model="env" type="radio" value="local" />本地</label>
            <label class="ml10"><input v-model="env" type="radio" value="native" />壳</label>
        </div>
        <div v-if="env === 'local'">
            <div class="label-name">IP:</div>
            <input v-model="ip" />
        </div>
        <div v-if="env === 'local'">
            <div class="label-name">Port:</div>
            <input v-model="port" />
        </div>
        <div v-if="env === 'local'">
            <div class="label-name">IOS/Android:</div>
            <label><input v-model="sys" type="radio" value="ios" />IOS</label>
            <label class="ml10"><input v-model="sys" type="radio" value="android" />Android</label>
        </div>
        <div v-if="env === 'native'">
            <div class="label-name">频道名:</div>
            <input v-model="pindao" value="rn_useCar" />
            <tag-t type="tags-pindao" name="pindao" :update-v="setV" :get-v="getV" ref="pindaoRef" :auto-save="autoSave"
                :input-value="pindao"></tag-t>
        </div>
        <div v-if="env === 'native'">
            <div class="label-name">配置名:</div>
            <input v-model="config" value="_crn_config" />
            <tag-t type="tags-config" name="config" :update-v="setV" :get-v="getV" ref="configRef" :auto-save="autoSave"
                :input-value="config"></tag-t>
        </div>
        <div>
            <div class="label-name">ModuleName:</div>
            <input v-model="name" value="rn_car_zt" />
            <tag-t type="tags-name" name="name" :update-v="setV" :get-v="getV" ref="tagsName" :auto-save="autoSave"
                :input-value="name"></tag-t>
        </div>
        <div>
            <div class="label-name">initialPage:</div>
            <input v-model="initial" value="Home" />
            <tag-t type="tags-initial" name="initial" :update-v="setV" :get-v="getV" ref="tagsInitial"
                :auto-save="autoSave" :input-value="initial"></tag-t>
        </div>
        <div class="text mtb15">
            <div>{{text}}</div>
        </div>

        <div class="ubt"><button id="create" @click="createQrcode">生成二维码</button>
            <div class="text ml10 inline-block">
                <label><input type="checkbox" v-model="isRecord" />记住现在的值</label>
            </div>
            <div class="text ml10 inline-block">
                <label><input type="checkbox" v-model="autoSave" />将输入值存入对应tag中</label>
            </div>
        </div>
        <div id="qrcode" class="qrcode"></div>

        <table border="1" cellspacing="0" style="margin-top: 20px" cellpadding="6">
            <thead>
                <tr>
                    <th>
                        链接
                    </th>
                    <th>
                        二维码
                    </th>
                    <th>
                        描述
                    </th>
                    <th>
                        频次
                    </th>
                    <th>
                        操作
                    </th>
                </tr>
            </thead>
            <tbody>

                <tr v-for="v in ofenList">
                    <td>{{v.link}}</td>
                    <td>{{v.qrcodeNode}}</td>
                    <td>{{v.desc}}</td>
                    <td>{{v.count}}</td>
                    <td>
                        <button>删除</button>
                        <button>生成二维码</button>
                        <button>添加修改描述</button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- <script src="./jquery.min.js"></script> -->
    <script src="./vue.min.js"></script>
    <script src="./qrcode.min.js"></script>
    <script src="./tag.js"></script>
    <script>
        var config = {
            c: {
                moduleName: 'CRNModuleName',
                type: 'CRNType',
                initialPage: 'initialPage'
            },
            q: {
                initialPage: 'initialPage',
                moduleName: 'QRNModuleName',
                type: 'QRNType',
            }
        }
        const watchers = ['qc', 'env', 'ip', 'port', 'name', 'initial', 'sys'];
        let calCount = false;
        let lastQrCode = '';
        // 在fillWithRecord的时候会导致重复计算count,使用setTimeout可解决此问题
        setTimeout(() => {
            calCount = true;
        }, 100)
        var app = new Vue({
            el: '#app',
            data: {
                qc: 'c',
                env: 'local',
                sys: 'android',
                ip: '192.168.2.24',
                port: '5389',
                name: 'rn_car_zt',
                initial: 'Home',
                isRecord: true,
                autoSave: true,
                pindao: 'rn_car_zt',
                config: '_crn_config',
                ofenList: [
                ]
            },
            watch: {
                ...watchers.reduce((acc, next) => {
                    acc[next] = function (v, o) {

                        this.createQrcode(null, calCount);
                    };
                    return acc;
                }, {}),
            },
            computed: {
                text: function () {
                    const text = this.env === 'local' ?
                        'http://' + this.ip + ':' + this.port + '/index.' + this.sys + '.bundle?'
                        + config[this.qc].moduleName + '=' + this.name + '&'
                        + config[this.qc].type + '=1&'
                        + config[this.qc].initialPage + '=' + this.initial
                        :
                        `/${this.pindao}/${this.config}?${config[this.qc].moduleName}=${this.name}&${config[this.qc].type}=1&${config[this.qc].initialPage}=${this.initial}`;
                    return text;

                }
            },
            mounted() {
                debugger
                this.storeTags();
                this.fillWithRecord();
            },
            methods: {
                storeTags: function () {
                    this.$refs.tagsName && this.$refs.tagsName.add(this.name);
                    this.$refs.tagsInitial && this.$refs.tagsInitial.add(this.initial);
                    this.$refs.pindaoRef && this.$refs.pindaoRef.add(this.pindao);
                    this.$refs.configRef && this.$refs.configRef.add(this.config);
                },
                getV: function (name) {
                    return this[name];
                },
                existInOfen: function (key) {
                    return this.ofenList.some(item => item.key === key);
                },
                calOfen: function () {

                },
                createQrcode: function (e, calCount) {
                    document.getElementById('qrcode').innerHTML = '';
                    qrcode = new QRCode(document.getElementById('qrcode'), this.text);

                    if (lastQrCode !== this.text) {

                        if (calCount !== false) {

                            if (this.existInOfen(this.text)) {
                                this.ofenList.map(item => {
                                    if (item.key === this.text) {
                                        item.count++;
                                    }
                                })
                            } else {
                                this.ofenList.push({
                                    key: this.text,
                                    count: 0,
                                    link: this.text,
                                    qrcodeNode: '',
                                    desc: ''
                                })
                            }
                        }
                    }
                    lastQrCode = this.text;
                    
                    if (this.isRecord) {
                        this.record();
                    }
                    if (this.autoSave) {
                        this.$refs.tagsName && this.$refs.tagsName.add(this.name);
                        this.$refs.tagsInitial && this.$refs.tagsInitial.add(this.initial);
                        this.$refs.pindaoRef && this.$refs.pindaoRef.add(this.pindao);
                        this.$refs.configRef && this.$refs.configRef.add(this.config);
                    }
                },
                setV: function (name, v) {
                    this[name] = v;
                },
                fillWithRecord: function () {
                    var qc = localStorage.getItem('qc');
                    if (qc) {
                        this.qc = qc;
                    }
                    var env = localStorage.getItem('env');
                    if (env) {
                        this.env = env;
                    }
                    var pindao = localStorage.getItem('pindao');
                    if (pindao) {
                        this.pindao = pindao;
                    }
                    var config = localStorage.getItem('config');
                    if (config) {
                        this.config = config;
                    }
                    var ip = localStorage.getItem('ip');
                    if (ip) {
                        this.ip = ip;
                    }
                    var port = localStorage.getItem('port');
                    if (port) {
                        this.port = port;
                    }
                    var sys = localStorage.getItem('sys');
                    if (sys) {
                        this.sys = sys;
                    }
                    var name = localStorage.getItem('name');
                    if (name) {
                        this.name = name;
                    }
                    var initial = localStorage.getItem('initial');
                    if (initial) {
                        this.initial = initial;
                    }
                    var ofenList = localStorage.getItem('ofenList');
                    if (ofenList) {
                        this.ofenList = JSON.parse(ofenList);
                    }
                },
                record: function () {
                    localStorage.setItem('qc', this.qc);
                    localStorage.setItem('ip', this.ip);
                    localStorage.setItem('env', this.env);
                    localStorage.setItem('pindao', this.pindao);
                    localStorage.setItem('config', this.config);
                    localStorage.setItem('port', this.port);
                    localStorage.setItem('sys', this.sys);
                    localStorage.setItem('name', this.name);
                    localStorage.setItem('initial', this.initial);
                    localStorage.setItem('ofenList', JSON.stringify(this.ofenList))
                }
            }
        });
        app.createQrcode(e, false);
    </script>
</body>

</html>